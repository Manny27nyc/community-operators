{% raw %}
name: Prepare Test Index

on:
  repository_dispatch:
    types:
      - manual-test-index
      - index-for-openshift-test

env:
{% endraw %}
  OPP_PRODUCTION_TYPE: "{{ default_config.production.type }}"

{% raw %}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: "prepare"
        id: variables
        env:
          OP_PR: ${{ github.event.client_payload.source_pr }}
{% endraw %}
        run: |
          tmpfile=$(mktemp /tmp/XXXXXX.json)
          curl -s https://api.github.com/repos/{{ default_config.pipeline.repo }}/pulls/$OP_PR -o $tmpfile
          REPO_FULL=$(cat $tmpfile | jq -r '.head.repo.clone_url')
          BRANCH=$(cat $tmpfile | jq -r '.head.ref')
          COMMIT=$(cat $tmpfile | jq -r '.head.sha')
          REPO=$(echo "$REPO_FULL"| awk -F'{{ default_config.pipeline.base }}/' '{print $2}')
          echo "::set-output name=opp_repo::$REPO"
          echo "::set-output name=opp_branch::$BRANCH"
          echo "::set-output name=opp_commit::$COMMIT"
          echo "Pull request #$1 : $REPO $BRANCH $COMMIT"
          rm -f $tmpfile > /dev/null 2>&1
{% raw %}

      - name: Build temp index and push
        env:
          # CONTAINER_TOOL: podman
          OP_DEBUG: 0
          OP_TOKEN: ${{ secrets.QUAY_API_TOKEN_OPERATOR_TESTING }}
          OPRT_SCRIPT: https://raw.githubusercontent.com/redhat-openshift-ecosystem/operator-test-playbooks/upstream-community/upstream/test/osr_run.sh
#          OP_PR: ${{ github.event.client_payload.source_pr }}
          REPO: ${{ steps.variables.outputs.opp_repo }}
          BRANCH: ${{ steps.variables.outputs.opp_branch }}
          COMMIT: ${{ steps.variables.outputs.opp_commit }}
          OPRT_REPO: ${{ steps.variables.outputs.opp_repo }}
          OPRT_SHA: ${{ steps.variables.outputs.opp_commit }}
{% endraw %}
          OPP_OPRT_SRC_REPO:  "{{ default_config.pipeline.repo }}"
          OPP_OPRT_SRC_BRANCH: "{{ default_config.pipeline.branch }}"
{% raw %}
        run: |
          echo ${{ github.event.client_payload.source_pr }} >> file
          echo
          echo
          echo -n "Preparing temp index for PR: "
          cat file
          echo
          echo
          bash <(curl -sL https://raw.githubusercontent.com/redhat-openshift-ecosystem/operator-test-playbooks/upstream-community/upstream/test/oprt.sh)
{% endraw %}
